<link rel="import" href="cart-data.html">
<link rel="import" href="item-cart.html" >
<link rel="import" href="progress-dialog.html" >
<dom-module id="cart-view">
    <template>
        <style>
            h1{
                color: black;
            }
            
            p{
                color: black;
            }
            h2{
                color: black;
            }
            .log{
                color: teal;
            }
            
            #bt-chekout-cart{
                @apply --layout-fixed-bottom;
                position: fixed;
                width: 100%;
                height: 64px;
                background-color: #9c27b0;
                color: white;
                font-weight: bold;
            }
        </style>
        
        <app-location
          route="[[route]]">
        </app-location>    

        <app-route
          route="{{route}}"
          pattern="/:key"
          data="{{routeData}}"
          tail="{{subroute}}"
          active="{{pageActive}}">
        </app-route>
        
        <firebase-auth            
            id="auth"
            user={{user}}>            
        </firebase-auth>
<!--
        <cart-data
            id="cartData"
            cart-key={{routeData.key}}
            data="{{data}}"
            has-itens={{hasItem}}
            is-ready={{isReady}}>
        </cart-data>
-->
        
        <firebase-query
           id="cartQuery"
           path="/carts"
           order-by-child="idUser"
           equal-to="{{user.uid}}"
           data="{{data}}"> 
        </firebase-query>
          
        <firebase-query
           id="cartItensQuery"
           path="{{pathItensCart}}"
           data="{{dataItens}}"> 
        </firebase-query>
            
        <h1>Carrinho</h1>        
        <div hidden$="[[hasItem]]">
            <p>Your <iron-icon icon="shopping-cart"></iron-icon> is empty.</p>
        </div>
        
        <progress-dialog id="progressDialog" visible=[[!isReady]]>
            Carregando Carrinho...
        </progress-dialog>

        <template is="dom-repeat" items="{{dataItens}}" as="item-cart">
            <div>
                <div class="item">
                   {{item-cart.name}}
                    <item-cart item={{item-cart}} on-delete="_deleteItemCart"></item-cart>
                </div>
            </div>
        </template>                  
        <paper-button id="bt-chekout-cart"><a href="/checkout">Avan√ßar</a></paper-button>
    </template>
    <script>
    class CartView extends Polymer.Element{
        static get is(){return 'cart-view'}
        
        static get properties(){
            return{
                cartList:{
                  type: Object,
                  observer: '_cartListChanged'    
                },
                route: {
                    type:Object                    
                },
                user:{
                    type: Object,
                    value: ""
                },
                data:{
                    type: Object,
                    observer: '_dataChanged'
                },
                pathItensCart:{
                    type: String,
                    value: ""
                },
                isReady:{
                    type: Boolean,
                    value: false
                }
            };
        }
        
        static get observers(){
            return [
//              '_routePageChanged(routeData.key)'          
            ];
        }
        
//        _routePageChanged(key){            
//            this.$.cartData._getItensCartData();
//         }   
        
        __stringfy(data){
            return JSON.stringify(data);
        }
        
        _deleteItemCart(e){
            let key = e.currentTarget.item.$key;
            this.$.cartData.removeItemCart(key)
        }
        
        _dataChanged(value){
            if(value != null && value.length > 0){
                console.log("Entrei no if");
                for(var i = 0 ; i < value.length ; i++){
                    console.log("cart Key = " + this.__stringfy(value[i].$key));
                    this.pathItensCart = '/carts/' + value[i].$key + '/itensCart';
                    this.isReady = true;
                }    
            }            
        }
        
        _extractArray(value){
            let itens;
            for(var item in value){
//                console.log(this.__stringfy(item));
                itens = item;
            }
            return itens;
        }    
    }
    window.customElements.define(CartView.is, CartView);
    </script>
</dom-module>