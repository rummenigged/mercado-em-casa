<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="progress-dialog.html">
<link rel="import" href="product-data.html">

<dom-module id="product-detail">
    <template>
        <style include="flaty-bootstrap"> 
            :host{
                display: block;
                color: black;
            }
            .container{
                color: black;
            }
            .price{
                color: green;
                font-weight: bold;
            }
            iron-image{
                width: 100%;
                height: 400px;
                background-color: lightgray;
            }
            
            .content-item{
                margin-bottom: 70px;
            }
            
            #bt-add-product-to-cart{
                @apply --layout-fixed-bottom;
                position: fixed;
                width: 100%;
                height: 64px;
                background-color: #9c27b0;
                color: white;
                font-weight: bold;                
            }
            
    /*        Small devices (landscape phones, 576px and up)*/
            @media (min-width: 576px) {
                iron-image{
                    height: 400px;
                }
                
                #bt-add-product-to-cart{
                    @apply --layout-fixed-bottom;
                    position: fixed;
                    width: 100%;
                    height: 64px;
                    background-color: #9c27b0;
                    color: white;
                    font-weight: bold;                
                }
            }

    /*        Medium devices (tablets, 768px and up)*/
            @media (min-width: 768px) {
                iron-image{
                    height: 400px;
                }
                
                #bt-add-product-to-cart{                    
                    position: relative;                    
                    height: 50px;                                    
                }
            }

    /*        Large devices (desktops, 992px and up)*/
            @media (min-width: 992px) {
                iron-image{
                    height: 500px;
                }
                
                #bt-add-product-to-cart{                    
                    position: absolute;                    
                    height: 50px;                                  
                }
            }

    /*        Extra large devices (large desktops, 1200px and up)*/
            @media (min-width: 1200px) {
                iron-image{
                    height: 600px;
                }
                
                #bt-add-product-to-cart{                    
                    position: relative;                    
                    height: 50px;                                    
                }
            }
        </style>        
        
        <app-route
            id="route"
            route=[[route]]
            pattern="/:idCategory/:category/:idItem/:item"
            data="{{routeData}}">
        </app-route>
        
        <firebase-auth 
            id="auth" 
            user="{{user}}">
        </firebase-auth>
         
        <product-data
            id="productData"
            category-id="{{routeData.idCategory}}"
            product-id="{{routeData.idItem}}"
            data="{{product}}"
            is-ready="{{isReady}}">
        </product-data>
                        
        <firebase-query
           id="cartKeyQuery"           
           path="/carts"
           order-by-child="idUser"
           equal-to="{{user.uid}}"
           data="{{cartData}}"> 
        </firebase-query>
        
        <div class="container">           
            <div class="row content-item">
                <iron-image class="col-12 col-xs-12 col-sm-12 col-md-6 col-lg-7" src="../../data/images/none.jpg" sizing="cover" preload fade></iron-image>            
                <div class="detail col-xs-12 col-sm-12 col-md-6 col-lg-4 offset-lg-1">                   
                        <h3>{{product.name}}</h3>
                        <span class="price">R${{product.price}}</span>
                        <paper-input id="qtd" label="Quantidade" type="number"></paper-input>
                        <h4>Descri√ßao</h4>
                        <p>{{product.description}}</p>
                        <template is="dom-repeat" items="{{cartData}}" as="item">
                            <p>{{item.$key}}</p>
                        </template>
                        <paper-button id="bt-add-product-to-cart" on-tap="_addCart">Adicionar ao Carrinho</paper-button>
                        <progress-dialog id="progressDialog" visible="{{!isReady}}">
                            Carregando Produto...
                        </progress-dialog>                                                            
                </div>
            </div>            
        </div>
    </template>
    <script>
        class ProductDetail extends Polymer.Element{
            static get is(){ return 'product-detail'}

            static get properties(){
                return{
                    item: {
                        type:Object,
                        readOnly: true                        
                    },                    
                    route: Object,                    
                    cartData:{
                        type: String,
                        value: "",                        
                    },
                    user:{
                        type: Object,
                        value: ""
                    }
                }
            }
            
            static get observers(){
                return [
//                    '_routePageChanged(routeData.item)'
                ] ;
            }

            _routePageChanged(item){
                this.itemPathName = item;                
            }
                                    
            _addCart(e){                
                let cartKey;
                
                if(this.cartData[0] != null){
                    cartKey = this.cartData[0].$key;
                }else{
                    cartKey = this.$.cartKeyQuery.ref.push({
                        idUser: this.user.uid
                    }).key;
                }
                
                console.log("Key Cart Product Detail = " + cartKey);
                let produto = new Object();
                produto["id"] = this.$.route.data.idItem;
                produto["name"] = this.$.productData.data.name;
                produto["qtd"] = this.$.qtd.value;
                produto["price"] = this.$.productData.data.price;
                console.log("Cart Key Product Detail = " + cartKey);
                this.$.productData._addProductToCart(produto, cartKey);
                
                this.$.qtd.value = null;
            }
        }
        window.customElements.define(ProductDetail.is, ProductDetail);
    </script>
</dom-module>